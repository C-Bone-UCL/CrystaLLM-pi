# Command I used that worked
sudo docker run -d \
  -u $(id -u):$(id -g) \
  -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  -v $(pwd)/outputs:/app/outputs \
  -e HF_KEY="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" \
  -e WANDB_KEY="5f5e743f253c050dda2db65cbf8864cd444f40b9" \
  -e TRITON_CACHE_DIR="/tmp/triton-cache" \
  -e USER="cyprien" \
  --name crystallm-api \
  crystallm-api

# Deduplicate and filter data - worked
curl -X POST "http://localhost:8000/preprocessing/deduplicate" \
  -H "Content-Type: application/json" \
  -d '{
    "input_parquet": "/app/data/SLME_1K.parquet",
    "output_parquet": "/app/data/SLME_1K_dedup.parquet",
    "property_columns": "[\"SLME\"]", 
    "filter_na_columns": "[\"SLME\"]", 
    "filter_zero_columns": "[\"SLME\"]", 
    "filter_negative_columns": "[\"SLME\"]"
  }'

# Clean and normalize CIF data - worked
curl -X POST "http://localhost:8000/preprocessing/clean" \
  -H "Content-Type: application/json" \
  -d '{
    "input_parquet": "/app/data/SLME_1K_dedup.parquet",
    "output_parquet": "/app/data/SLME_1K_clean.parquet",
    "num_workers": 4,
    "property_columns": "[\"SLME\"]",
    "property1_normaliser": "linear"
  }'

# Save dataset to Huggingface - worked
curl -X POST "http://localhost:8000/preprocessing/save-dataset" \
  -H "Content-Type: application/json" \
  -d '{
    "input_parquet": "/app/data/SLME_1K_clean.parquet",
    "output_parquet": "/app/data/SLME_1K_dtest.parquet",
    "test_size": 0.1,
    "valid_size": 0.1,
    "HF_username": "c-bone",
    "save_hub": true,
    "save_local": false
  }'


# Train
## Single GPU - doesnt actually use the GPU, goes to CPU (- worked with CPU)
curl -X POST "http://localhost:8000/train" \
  -H "Content-Type: application/json" \
  -d '{
    "config_file": "data/SLME_1K_dtest_train.jsonc",
    "multi_gpu": false
  }'  

# would need to make sure we cann get access to gpus to test multi or single GPU

# Generate
## Also goes to CPU - doesn't work because args fed in incorrectly
curl -X POST "http://localhost:8000/generate/direct" \
  -H "Content-Type: application/json" \
  -d '{
    "hf_model_path": "c-bone/CrystaLLM-2.0_bandgap",
    "manual": true,
    "compositions": "Ti2O4",
    "condition_lists": ["1.8", "0.0"],
    "spacegroups": "P4_2/mnm",
    "level": "level_4",
    "num_return_sequences": 5,
    "max_return_attempts": 10,
    "output_parquet": "/app/outputs/generated_structures.parquet"
  }'



curl -X GET "http://localhost:8000/jobs/1f24e94a-e723-4ada-ab83-3d29f86c8f79"